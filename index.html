<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucro Certo Lite</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: sans-serif; background: #f8f9fa; margin: 0; padding: 20px; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { color: #27ae60; text-align: center; font-size: 24px; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: #27ae60; color: white; border: none; font-weight: bold; cursor: pointer; }
        .result-box { background: #e8f5e9; padding: 15px; border-radius: 5px; margin-top: 20px; display: none; border-left: 5px solid #27ae60; }
        .history-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; font-size: 13px; }
        #customModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 85%; max-width: 300px; text-align: center; }
        .modal-btn { padding: 10px; margin: 5px; border-radius: 5px; border: none; cursor: pointer; min-width: 80px; }
        .cancel { background: #95a5a6; color: white; }
    </style>
</head>
<body>
<div class="container">
    <h1>Lucro Certo Lite</h1>
    <input type="text" id="pName" placeholder="Nome do Produto">
    <input type="number" id="pCost" placeholder="Custo (R$)">
    <input type="number" id="pMargin" placeholder="Margem (%)">
    <input type="number" id="pQty" placeholder="Quantidade" value="1">
    <button onclick="calcular()">CALCULAR</button>

    <div id="displayResultado" class="result-box">
        <p>Preço Sugerido: <strong id="resPreco"></strong></p>
        <p>Lucro Unitário: <strong id="resLucroUni"></strong></p>
        <p>Lucro Total: <strong id="resLucroTotal"></strong></p>
    </div>

    <div style="margin-top:30px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span style="font-size:12px; font-weight:bold;">HISTÓRICO (<span id="count">0</span>/20)</span>
            <button onclick="exportCSV()" style="width:auto;padding:5px 10px;font-size:11px;background:#34495e;margin:0;">Exportar CSV</button>
        </div>
        <div id="historyList"></div>
        <div style="text-align:center; margin-top:15px;">
            <button onclick="confirmReset()" style="background:#e74c3c; width:auto; padding:8px 15px; font-size:12px;">Resetar Histórico</button>
        </div>
    </div>
</div>

<div id="customModal">
    <div class="modal-content">
        <div id="modalMsg" style="margin-bottom:20px;"></div>
        <div id="modalBtns"></div>
    </div>
</div>

<script>
let db = JSON.parse(localStorage.getItem('lucro_certo_pwa_v1') || '[]');

function mostrarModal(msg, buttons=[]) {
    document.getElementById('modalMsg').innerText = msg;
    const container = document.getElementById('modalBtns');
    container.innerHTML = "";
    buttons.forEach(btn=>{
        const b = document.createElement('button');
        b.className = 'modal-btn' + (btn.cancel ? ' cancel' : '');
        b.innerText = btn.text;
        b.onclick = btn.action;
        container.appendChild(b);
    });
    document.getElementById('customModal').style.display = 'flex';
}

function fecharModal(){ document.getElementById('customModal').style.display = 'none'; }

function calcular() {
    const custo = parseFloat(document.getElementById('pCost').value);
    const margem = parseFloat(document.getElementById('pMargin').value);
    const quantidade = parseInt(document.getElementById('pQty').value);

    if (isNaN(custo) || custo <= 0) return mostrarModal("Custo inválido.", [{text:"OK", action:fecharModal}]);
    if (isNaN(margem) || margem < 0 || margem >= 100) return mostrarModal("Margem (0-99%).", [{text:"OK", action:fecharModal}]);
    
    const precoSugerido = custo / (1 - (margem / 100));
    const lucroUnitario = precoSugerido - custo;
    const lucroTotal = lucroUnitario * (quantidade || 1);
    const fmt = v => v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});

    document.getElementById('resPreco').innerText = "R$ "+fmt(precoSugerido);
    document.getElementById('resLucroUni').innerText = "R$ "+fmt(lucroUnitario);
    document.getElementById('resLucroTotal').innerText = "R$ "+fmt(lucroTotal);
    document.getElementById('displayResultado').style.display = 'block';

    if(db.length>=20) db.pop();
    db.unshift({
        data: new Date().toLocaleDateString('pt-BR'),
        hora: new Date().toLocaleTimeString('pt-BR',{hour12:false}),
        nome: document.getElementById('pName').value || 'Produto',
        quantidade: quantidade || 1,
        margem: margem,
        preco: fmt(precoSugerido),
        lucroUnitario: fmt(lucroUnitario),
        lucroTotal: fmt(lucroTotal)
    });
    localStorage.setItem('lucro_certo_pwa_v1', JSON.stringify(db));
    renderHistory();
}

function renderHistory(){
    document.getElementById('count').innerText = db.length;
    document.getElementById('historyList').innerHTML = db.map(i=>`
        <div class="history-item">
            <span>${i.data} - ${i.nome}</span>
            <strong>R$ ${i.preco}</strong>
        </div>
    `).join('');
}

function confirmReset(){
    if(db.length===0) return;
    mostrarModal("Apagar tudo?",[
        {text:"Não", action:fecharModal, cancel:true},
        {text:"Sim", action:()=>{ db=[]; localStorage.removeItem('lucro_certo_pwa_v1'); renderHistory(); fecharModal(); }}
    ]);
}

function exportCSV(){
    if(db.length===0) return;
    let csv=`"Data";"Produto";"Preco";"Lucro"\n`;
    db.forEach(r=> csv+=`"${r.data}";"${r.nome}";"${r.preco}";"${r.lucroTotal}"\n`);
    const blob=new Blob(["\uFEFF"+csv],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="lucro_certo.csv";
    a.click();
}

renderHistory();

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').then(()=>console.log('PWA OK'));
  });
}
</script>
</body>
</html>
