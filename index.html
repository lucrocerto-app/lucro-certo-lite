            <span>HISTÓRICO RECENTE (<span id="count">0</span>/20)</span>
            <button onclick="exportCSV()" style="width:auto;padding:6px 10px;font-size:12px;background:#334155;">Exportar CSV</button>
        </div>
        <div id="historyList"></div>
        <div style="text-align:center;">
            <button class="reset-btn" onclick="confirmReset()">Resetar Histórico</button>
        </div>
    </div>
</div>

<!-- MODAL -->
<div id="customModal">
    <div class="modal-content">
        <div class="modal-title" id="modalTitle">Lucro Certo</div>
        <div class="modal-msg" id="modalMsg">Mensagem aqui</div>
        <div id="modalBtns"></div>
    </div>
</div>

<script>
let db = JSON.parse(localStorage.getItem('lucro_certo_pwa_v1') || '[]');

function mostrarModal(msg, buttons=[]) {
    document.getElementById('modalMsg').innerText = msg;
    const container = document.getElementById('modalBtns');
    container.innerHTML = "";
    buttons.forEach(btn=>{
        const b = document.createElement('button');
        b.className = 'modal-btn'+(btn.cancel ? ' cancel':'');
        b.innerText = btn.text;
        b.onclick = btn.action;
        container.appendChild(b);
    });
    document.getElementById('customModal').style.display = 'flex';
}

function fecharModal(){
    document.getElementById('customModal').style.display = 'none';
}

function calcular() {
    const custo = parseFloat(document.getElementById('pCost').value);
    const margem = parseFloat(document.getElementById('pMargin').value);
    const quantidade = parseInt(document.getElementById('pQty').value);

    if (isNaN(custo) || custo <= 0) return mostrarModal("Insira um custo válido.", [{text:"OK", action:fecharModal}]);
    if (isNaN(margem) || margem < 0 || margem >= 100) return mostrarModal("Margem inválida (0-99%).", [{text:"OK", action:fecharModal}]);
    if (isNaN(quantidade) || quantidade < 1) return mostrarModal("Quantidade mínima é 1.", [{text:"OK", action:fecharModal}]);

    const precoSugerido = custo / (1 - (margem / 100));
    const lucroUnitario = precoSugerido - custo;
    const lucroTotal = lucroUnitario * quantidade;
    const fmt = v => v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});

    document.getElementById('resPreco').innerText = "R$ "+fmt(precoSugerido);
    document.getElementById('resLucroUni').innerText = "R$ "+fmt(lucroUnitario);
    document.getElementById('resLucroTotal').innerText = "R$ "+fmt(lucroTotal);
    document.getElementById('displayResultado').style.display = 'block';

    if(db.length>=20) db.pop();

    db.unshift({
        data: new Date().toLocaleDateString('pt-BR'),
        hora: new Date().toLocaleTimeString('pt-BR',{hour12:false}),
        nome: document.getElementById('pName').value || 'Produto',
        quantidade: quantidade,
        margem: margem,
        preco: fmt(precoSugerido),
        lucroUnitario: fmt(lucroUnitario),
        lucroTotal: fmt(lucroTotal)
    });

    localStorage.setItem('lucro_certo_pwa_v1', JSON.stringify(db));
    renderHistory();
}

function renderHistory(){
    document.getElementById('count').innerText = db.length;
    document.getElementById('historyList').innerHTML = db.map(i=>`
        <div class="history-item">
            <span>${i.data} ${i.hora} - ${i.nome} (${i.quantidade})</span>
            <strong>R$ ${i.preco}</strong>
        </div>
    `).join('');
}

function confirmReset(){
    if(db.length===0) return mostrarModal("Não há histórico para resetar.",[{text:"OK", action:fecharModal}]);
    mostrarModal("Deseja realmente apagar todo o histórico?",[
        {text:"Cancelar", action:fecharModal, cancel:true},
        {text:"Confirmar", action:()=>{
            db=[];
            localStorage.removeItem('lucro_certo_pwa_v1');
            renderHistory();
            fecharModal();
            mostrarModal("Histórico apagado com sucesso!",[{text:"OK", action:fecharModal}]);
        }}
    ]);
}

function exportCSV(){
    if(db.length===0) return mostrarModal("Não há histórico para exportar.",[{text:"OK", action:fecharModal}]);
    let csvContent=`"Data";"Hora";"Produto";"Quantidade";"Margem (%)";"Preço Sugerido";"Lucro Unitário";"Lucro Total"\r\n`;
    db.forEach(row=>{
        csvContent+=`"${row.data}";"${row.hora}";"${row.nome}";"${row.quantidade}";"${row.margem}";"${row.preco}";"${row.lucroUnitario}";"${row.lucroTotal}"\r\n`;
    });
    const blob=new Blob(["\uFEFF"+csvContent],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const link=document.createElement("a");
    link.setAttribute("href",url);
    const now=new Date();
    const fileName=`historico_lucrocerto_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.csv`;
    link.setAttribute("download",fileName);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

renderHistory();
</script> 
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function () {
    navigator.serviceWorker.register('./service-worker.js')
      .then(function () {
        console.log('Service Worker registrado com sucesso');
      });
  });
}
</script>
</body>

</html>


