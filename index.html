<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LUCRO CERTO LITE</title>
<style>
:root { --primary: #27ae60; --bg: #f8f9fa; --text: #334155; }
* { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
body { background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
.container { width: 100%; max-width: 450px; }
.header { text-align: center; margin-bottom: 20px; }
.header h1 { color: var(--primary); margin: 0; font-size: 26px; text-transform: uppercase; font-weight: 800; }
.card { background: white; padding: 18px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #e2e8f0; }
label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; color: #64748b; }
input { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 16px; background: #fff; outline: none; }
input:focus { border-color: var(--primary); }
#displayResultado { display: none; background: #f0fdf4; color: var(--primary); border: 2px solid var(--primary); padding: 20px; border-radius: 8px; text-align: center; margin-top: 20px; }
.res-label { font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; display: block; }
.res-valor { font-size: 32px; font-weight: 900; display: block; }
button { width: 100%; padding: 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; background: var(--primary); color: white; font-size: 18px; text-transform: uppercase; margin-top: 10px; }
.lucro-info { display: flex; justify-content: space-around; margin-top: 10px; font-size: 13px; border-top: 1px dashed #27ae60; padding-top: 10px; }
.history-header { display: flex; justify-content: space-between; align-items: center; font-size: 12px; font-weight: bold; margin-bottom: 5px; }
.history-item { font-size: 12px; padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
.reset-btn { background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; margin-top: 8px; }

/* MODAL CUSTOMIZADO */
#customModal {
    display: none;
    position: fixed;
    z-index: 999;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.5);
    justify-content: center; align-items: center;
}
.modal-content {
    background: white;
    border-radius: 8px;
    padding: 20px;
    max-width: 320px;
    text-align: center;
}
.modal-title { color: var(--primary); font-weight: bold; margin-bottom: 10px; font-size: 18px; }
.modal-msg { font-size: 14px; margin-bottom: 15px; color:#334155; }
.modal-btn { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; margin:5px; }
.modal-btn.cancel { background: #ccc; color:#333; }
</style>
</head>
<body>

<div class="container">
    <!-- Cabeçalho -->
    <div class="header">
        <h1>LUCRO CERTO <span style="background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; vertical-align: middle;">LITE</span></h1>
        <p style="font-size:12px; margin:5px 0; color: #64748b;">Preço exato, sem complicação</p>
    </div>

    <!-- Card de cálculo -->
    <div class="card">
        <label>Nome do Produto (opcional)</label>
        <input type="text" id="pName" placeholder="Ex: Item">
        
        <label>Custo (R$)</label>
        <input type="number" id="pCost" placeholder="0,00" step="0.01">
        
        <label>Margem (%)</label>
        <input type="number" id="pMargin" value="30" step="0.1">
        
        <label>Quantidade (mínimo 1)</label>
        <input type="number" id="pQty" value="1" min="1">

        <button onclick="calcular()">CALCULAR AGORA</button>

        <div id="displayResultado">
            <span class="res-label">Preço Sugerido (R$)</span>
            <span class="res-valor" id="resPreco">R$ 0,00</span>
            
            <div class="lucro-info">
                <div>Lucro/Uni: <br><strong id="resLucroUni">R$ 0,00</strong></div>
                <div>Lucro Total: <br><strong id="resLucroTotal">R$ 0,00</strong></div>
            </div>
        </div>
    </div>

    <!-- Card de histórico -->
    <div class="card">
        <div class="history-header">
            <span>HISTÓRICO RECENTE (<span id="count">0</span>/20)</span>
            <button onclick="exportCSV()" style="width:auto;padding:6px 10px;font-size:12px;background:#334155;">Exportar CSV</button>
        </div>
        <div id="historyList"></div>
        <div style="text-align:center;">
            <button class="reset-btn" onclick="confirmReset()">Resetar Histórico</button>
        </div>
    </div>
</div>

<!-- MODAL -->
<div id="customModal">
    <div class="modal-content">
        <div class="modal-title" id="modalTitle">Lucro Certo</div>
        <div class="modal-msg" id="modalMsg">Mensagem aqui</div>
        <div id="modalBtns"></div>
    </div>
</div>

<script>
let db = JSON.parse(localStorage.getItem('lucro_certo_pwa_v1') || '[]');

function mostrarModal(msg, buttons=[]) {
    document.getElementById('modalMsg').innerText = msg;
    const container = document.getElementById('modalBtns');
    container.innerHTML = "";
    buttons.forEach(btn=>{
        const b = document.createElement('button');
        b.className = 'modal-btn'+(btn.cancel ? ' cancel':'');
        b.innerText = btn.text;
        b.onclick = btn.action;
        container.appendChild(b);
    });
    document.getElementById('customModal').style.display = 'flex';
}

function fecharModal(){
    document.getElementById('customModal').style.display = 'none';
}

function calcular() {
    const custo = parseFloat(document.getElementById('pCost').value);
    const margem = parseFloat(document.getElementById('pMargin').value);
    const quantidade = parseInt(document.getElementById('pQty').value);

    if (isNaN(custo) || custo <= 0) return mostrarModal("Insira um custo válido.", [{text:"OK", action:fecharModal}]);
    if (isNaN(margem) || margem < 0 || margem >= 100) return mostrarModal("Margem inválida (0-99%).", [{text:"OK", action:fecharModal}]);
    if (isNaN(quantidade) || quantidade < 1) return mostrarModal("Quantidade mínima é 1.", [{text:"OK", action:fecharModal}]);

    const precoSugerido = custo / (1 - (margem / 100));
    const lucroUnitario = precoSugerido - custo;
    const lucroTotal = lucroUnitario * quantidade;
    const fmt = v => v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});

    document.getElementById('resPreco').innerText = "R$ "+fmt(precoSugerido);
    document.getElementById('resLucroUni').innerText = "R$ "+fmt(lucroUnitario);
    document.getElementById('resLucroTotal').innerText = "R$ "+fmt(lucroTotal);
    document.getElementById('displayResultado').style.display = 'block';

    if(db.length>=20) db.pop();

    db.unshift({
        data: new Date().toLocaleDateString('pt-BR'),
        hora: new Date().toLocaleTimeString('pt-BR',{hour12:false}),
        nome: document.getElementById('pName').value || 'Produto',
        quantidade: quantidade,
        margem: margem,
        preco: fmt(precoSugerido),
        lucroUnitario: fmt(lucroUnitario),
        lucroTotal: fmt(lucroTotal)
    });

    localStorage.setItem('lucro_certo_pwa_v1', JSON.stringify(db));
    renderHistory();
}

function renderHistory(){
    document.getElementById('count').innerText = db.length;
    document.getElementById('historyList').innerHTML = db.map(i=>`
        <div class="history-item">
            <span>${i.data} ${i.hora} - ${i.nome} (${i.quantidade})</span>
            <strong>R$ ${i.preco}</strong>
        </div>
    `).join('');
}

function confirmReset(){
    if(db.length===0) return mostrarModal("Não há histórico para resetar.",[{text:"OK", action:fecharModal}]);
    mostrarModal("Deseja realmente apagar todo o histórico?",[
        {text:"Cancelar", action:fecharModal, cancel:true},
        {text:"Confirmar", action:()=>{
            db=[];
            localStorage.removeItem('lucro_certo_pwa_v1');
            renderHistory();
            fecharModal();
            mostrarModal("Histórico apagado com sucesso!",[{text:"OK", action:fecharModal}]);
        }}
    ]);
}

function exportCSV(){
    if(db.length===0) return mostrarModal("Não há histórico para exportar.",[{text:"OK", action:fecharModal}]);
    let csvContent=`"Data";"Hora";"Produto";"Quantidade";"Margem (%)";"Preço Sugerido";"Lucro Unitário";"Lucro Total"\r\n`;
    db.forEach(row=>{
        csvContent+=`"${row.data}";"${row.hora}";"${row.nome}";"${row.quantidade}";"${row.margem}";"${row.preco}";"${row.lucroUnitario}";"${row.lucroTotal}"\r\n`;
    });
    const blob=new Blob(["\uFEFF"+csvContent],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const link=document.createElement("a");
    link.setAttribute("href",url);
    const now=new Date();
    const fileName=`historico_lucrocerto_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.csv`;
    link.setAttribute("download",fileName);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

renderHistory();
</script>
</body>
</html>